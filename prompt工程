
import re
import json
from transformers import AutoTokenizer, AutoModelForCausalLM
import torch
TF_ENABLE_ONEDNN_OPTS=0
# 定义数据结构和示例，用于后续prompt
schema = {'病历条目': [ '主诉', '现病史', '既往病史']}
IE_PATTERN = "{}\n\n请提取上述句子中{}类型的实体，输出JSON格式，如果上述句子没有该信息，则用['未提供']来表示，多个值之间用','分隔。"

ie_examples = {
    'example1': {
        "sentence": "医生：你好，有哪儿里不舒服的吗？患者：肚子上面那里有点痛。就很闷。医生：这个有多少年了呢患者：有七年了。最近三个月痛的更厉害了，次数还多了。医生：一般是什么时候痛呢，吃饭前还是吃饭后患者：吃饭前。医生：吃完饭以后有没有好一点患者：好很多了。但这几个月吃完东西还是感觉很痛。医生：最近皮肤颜色有变化吗，会不会有想吐的情况患者：没有。医生：大便正常吗，有没有黑便什么的患者：有时候有一点黑。医生：以前有没有吃过什么药患者：没有。医生：之前有做过胃镜什么的吗患者：没有，没做过什么检查。医生：最近吃的怎么样，体重有没有轻了患者：吃的挺好的，没有轻。医生：以前还有其他的病吗，糖尿病高血压这些有吗，冠心病有吗患者：有高血脂3年了，别的都没有。",
        "answers": {
            "主诉": "头痛，头晕，睡眠不佳，经常发作",
            "现病史": "已经持续两年多头痛，尤其是头部里面半边，有时会连带着额头痛得非常厉害，反反复复的发作。在去其他医院检查时被诊断为顽固性偏头疼，并开了些药物，吃药时效果较好，但如果停止服药，头痛就会变得更加严重，表现为头胀、恶心等。这种疼痛发作的频率大约是一周一到两次，且以压力大、焦虑或休息不好时更为明显。患者同时表示在头痛发作期间会感到头晕，甚至有时候会有昏厥的感觉，日常生活中也会出现心烦意乱的症状。",
            "既往病史": "无。"
        }
    },
    'example2':{
        "sentence": "患者：医生你好 医生：你好，有什么不舒服的吗 患者：医生我经常头痛啊，就是右半边头这里，有时候还连着额头一起痛，很痛啊，反反复复的，之前去其他医院检查，那里的医生说我这个是顽固性偏头痛，给我开了点药，吃了就好点，不吃就又痛了 医生：具体是一些什么药呢 患者：布洛芬之类的，不太记得了 医生：你这个头痛大概有多久了 患者：大概有两年了吧 医生：是怎么样的痛法 患者：就是那种一跳一跳的疼痛 医生：头痛一般在什么时候发作为主 患者：每当我焦虑或者休息不好的时候就容易发作 医生：你头痛起来会晕吗 患者：会啊，就是感觉整个人昏昏沉沉的那种 医生：没有那种整个屋子都在转的感觉吧 患者：没有 医生：痛起来有没有呕吐 患者：没有，但会有想吐的感觉 医生：你扭扭脖子，现在会感觉头晕吗 患者：现在暂时没有，但是感觉脖子后面那块肌肉很僵硬，不太舒服 医生：平时出汗多吗？ 患者：不多，基本没有汗，而且有的时候感觉整个人有点发冷 医生：有流鼻涕、咳嗽吗？ 患者：会流鼻涕，但没咳嗽 医生：鼻涕什么颜色，清的还是浓的？ 患者：透明的，清涕 医生：平时胃口怎么样 患者：胃口还可以 医生：晚上睡觉呢 患者：头痛起来就睡不好 医生：小便正常吗？有没有尿频尿急尿痛？ 患者：没有，挺正常的 大便呢？成形吗 患者：成形的，一天一般拉一次 医生：好，还有没有其他不舒服的 患者：好像没了 医生：有没有糖尿病、高血压之类的基础病 患者：没有 医生：有没有乙肝结核之类的传染病？ 患者：没有 医生：有没有什么药物过敏？ 患者：没有 医生：看一下舌头 医生：伸手出来把一下脉 医生：你这种情况呢，考虑是中了风寒，又没有汗，邪气散不出去，一直积聚在体内，影响了太阳经，太阳经的走行就是从头部一直沿着脖子后面下去的，所以你老是反反复复头痛，脖子后面的肌肉又感觉不舒服，我先给你开三剂药，里面的麻黄记得先煎，把上面的浮沫去掉，药煲好之后趁热喝，出一下汗，但是小心不要吹风又受凉了。中药你是要自己拿回去煲呢还是代煎？ 患者：自己拿回去煲吧 医生：好，药吃完了记得回来复诊 患者：好，我明白了，谢谢医生",
        "answers": {
            "主诉": "头痛 风寒头痛证",
            "现病史": "患者两年前无明显诱因出现右侧偏头痛，常连及前额，呈搏动性疼痛，时痛时止，每当情绪紧张或劳累时易发作，曾在外院诊断“顽固性偏头痛”，予止痛治疗（具体不详），效果不佳，现伴头晕、恶心、颈部僵硬不适、流清涕、无汗恶寒，头晕发作时呈昏沉感，纳可，睡眠不佳，二便调，舌淡苔白，脉浮数。",
            "既往病史": "无。"
         }
    },
    # 'example3':{
    #     "sentence": "医生：您好，您叫什么名字，今年多大年纪呢？患者：医生您好，我叫张华，今年55岁了。医生：请告诉我您的诊疗卡号。患者：我的诊疗卡号是12345678。医生：您是哪里不舒服呢？患者：医生，我最近一个月总是感觉腹部不舒服，而且我发现我的皮肤和眼睛都变黄了，食欲也下降了，体重也减轻了。医生：这种情况持续了多久了？患者：大概一个月左右。医生：您有没有其他症状，比如恶心、呕吐或者腹痛？患者：没有恶心呕吐，但是食欲不好，偶尔会有轻微的腹痛。医生：您有没有发热或者大便颜色改变？患者：没有发热，大便颜色比较浅。医生：您以前有没有患过什么疾病？患者：我有乙型肝炎，已经10年了，而且我过去经常喝酒。20多年了医生：了解了，您这种情况我们初步考虑可能是肝硬化。我需要给您做一些检查，包括肝功能测试和腹部B超。患者：好的，医生，我听您的。医生：根据检查结果，您的肝功能指标有些异常，B超也显示肝脏表面不光滑，回声增强，这与肝硬化的表现相符。我将给您开一些中药来调理，同时您需要戒酒，饮食要清淡。患者：医生，这病严重吗？我还能治好吗？医生：肝硬化是一种慢性病，需要长期管理和治疗。我们会根据您的具体情况制定治疗方案，同时您需要配合我们的治疗和建议，定期复查。患者：好的，我会按照您说的做。医生：这是您的处方，您需要按照说明煎药和服用。记得一周后回来复诊，看看病情有没有改善。患者：明白了，谢谢医生。",
    #      "answers": {
    #         "主诉": "腹部不适伴黄疸1个月。",
    #         "现病史": "患者1个月前无明显诱因出现腹部不适，伴有黄疸，食欲减退，体重下降。曾在外院诊断为“肝硬化”，予保肝治疗（具体不详），效果不佳，现仍感腹部不适，食欲差，皮肤及巩膜黄染，大便色浅，小便黄，无发热，无腹痛，无恶心呕吐，睡眠尚可，二便调。",
    #         "既往史": "患者有乙型肝炎病史10年，长期饮酒史20余年。"
    #     }
    # }
}


def init_prompts():
    ie_prefix = [
        "需要你协助完成病历信息抽取任务，当我给你一个病人自述时，帮我抽取出句子中的主诉(即患者自我表达自身症状及其持续时间、性质或程度等，可为医生提供诊断疾病的方向。不超过20字)，现病史(现病史是主要部分，包括询问患者的症状发作日期以及症状、原因等，并且要询问患者的一般情况，如食欲、体重、睡眠等)，既往病史(即询问患者过去曾患有过什么疾病，以及既往有无外伤、手术等各种情况，尤其是与患者就诊时相关的病史要仔细询问)，并按照JSON的格式输出，如果缺少信息用‘无’来表示，多个值之间用','分隔。",
        "好的，我将只以json格式输出。"
    ]
    properties_str = '，'.join(schema['病历条目'])
    schema_str_list = f'"病历条目"({properties_str})'
    for key, example in ie_examples.items():
        sentence = example['sentence']
        formatted_prompt = IE_PATTERN.format(sentence, schema_str_list)
        answers_json = json.dumps(example['answers'], ensure_ascii=False)
        ie_prefix.append((formatted_prompt, answers_json))
    return {'ie_prefix': ie_prefix}

def format_output(response: str):
    if '```json' in response :
# response = response.replace("\n","")
        res = re.findall(r'```json((.|\n)*?)```', response)
        if len(res) and res[0]:
            response = res[0]
            response = response[0]
            response = response.replace('、', ',')
        elif '{' in response:
            pattern = r'{((.|\n)*?)}'
            res = re.findall(pattern, response)
            if len(res) and res[0]:
                response = res[0]
                response = '{' + response + '}'
                response = response.replace('、', ',')
        try:
            return(json.loads(response))
        except:
            return(response)

# ########使用chat函数
# def inference(sentences: list, custom_settings: dict):
#     # response, history_request = model.chat(tokenizer,
#     #                                "需要你协助完成病历信息抽取任务，当我给你一个病人自述时，帮我抽取出句子中的主诉(即患者自我表达自身症状及其持续时间、性质或程度等，可为医生提供诊断疾病的方向。不超过20字)，现病史(现病史是主要部分，包括询问患者的症状发作日期以及症状、原因等，并且要询问患者的一般情况，如食欲、体重、睡眠等)，既往病史(即询问患者过去曾患有过什么疾病，以及既往有无外伤、手术等各种情况，尤其是与患者就诊时相关的病史要仔细询问)，并按照JSON的格式输出，如果缺少信息用‘无’来表示，多个值之间用','分隔。",
#     #                                history=None)
#     for sentence in sentences:
#         properties_str = '，'.join(schema['病历条目'])
#         schema_str_list = f"‘病历条目’({properties_str})"
#         sentence_with_ie_prompt = IE_PATTERN.format(sentence, schema_str_list)
#         # result,history = model.chat(tokenizer, sentence_with_ie_prompt, history=custom_settings['ie_prefix'])
#         result, history = model.chat(tokenizer,
#                                        "需要你协助完成病历信息抽取任务，当我给你一个病人自述时，帮我总结出句子中的主诉(即患者自我表达自身症状及其持续时间、性质或程度等，可为医生提供诊断疾病的方向。不超过20字)，现病史(现病史是主要部分，包括询问患者的症状发作日期以及症状、原因等，并且要询问患者的一般情况，如食欲、体重、睡眠等)，既往病史(即询问患者过去曾患有过什么疾病，以及既往有无外伤、手术等各种情况，尤其是与患者就诊时相关的病史要仔细询问)，注意不能使用原句，并按照JSON的格式输出，如果缺少信息用‘无’来表示，多个值之间用','分隔。"+sentence_with_ie_prompt,
#                                        history=None)
#         # result, history = model.chat(tokenizer, sentence_with_ie_prompt, history=history_request)
#         # result = format_output(result)
#         print(sentence)
#         print(result)

#######使用generate函数
def inference(sentences: list, custom_settings: dict):

    # 准备初始提示信息
    prompt = "需要你协助完成病历信息抽取任务，当我给你一个病人自述时，帮我抽取出句子中的主诉(即患者自我表达自身症状及其持续时间、性质或程度等，可为医生提供诊断疾病的方向。不超过20字)，现病史(现病史是主要部分，包括询问患者的症状发作日期以及症状、原因等，并且要询问患者的一般情况，如食欲、体重、睡眠等)，既往病史(即询问患者过去曾患有过什么疾病，以及既往有无外伤、手术等各种情况，尤其是与患者就诊时相关的病史要仔细询问)，并按照JSON的格式输出，一共有三个key，注意不能使用原句，如果缺少信息用‘无’来表示，多个值之间用','分隔。"

    # 对每个句子进行处理
    for sentence in sentences:
        # 编码提示信息和句子
        inputs = tokenizer.encode(prompt + " " + sentence, return_tensors='pt')
        generated_ids = model.generate(input_ids=inputs, max_length=512)
        generated_text = tokenizer.decode(generated_ids[0], skip_special_tokens=True)
        # result = format_output(generated_text)
        print("原始句子：", sentence)
        # print("格式化结果：", result)
        print("格式化结果：", generated_text)

if __name__ == "__main__":
    # try:
        tokenizer = AutoTokenizer.from_pretrained("qwen/Qwen-7B-Chat", use_fast=False, trust_remote_code=True)
        model = AutoModelForCausalLM.from_pretrained("qwen/Qwen-7B-Chat", device_map="cpu", torch_dtype=torch.bfloat16,trust_remote_code=True)
        model=model.to('cpu')
        sentences = [
            '医生：你好，有哪儿里不舒服的吗？患者：肚子上面那里有点痛。就很闷。医生：这个有多少年了呢患者：有七年了。最近三个月痛的更厉害了，次数还多了。医生：一般是什么时候痛呢，吃饭前还是吃饭后患者：吃饭前。医生：吃完饭以后有没有好一点患者：好很多了。但这几个月吃完东西还是感觉很痛。医生：最近皮肤颜色有变化吗，会不会有想吐的情况患者：没有。医生：大便正常吗，有没有黑便什么的患者：有时候有一点黑。医生：以前有没有吃过什么药患者：没有。医生：之前有做过胃镜什么的吗患者：没有，没做过什么检查。医生：最近吃的怎么样，体重有没有轻了患者：吃的挺好的，没有轻。医生：以前还有其他的病吗，糖尿病高血压这些有吗，冠心病有吗患者：有高血脂3年了，别的都没有。',
            '患者：医生你好 医生：你好，有什么不舒服的吗 患者：医生我经常头痛啊，就是右半边头这里，有时候还连着额头一起痛，很痛啊，反反复复的，之前去其他医院检查，那里的医生说我这个是顽固性偏头痛，给我开了点药，吃了就好点，不吃就又痛了 医生：具体是一些什么药呢 患者：布洛芬之类的，不太记得了 医生：你这个头痛大概有多久了 患者：大概有两年了吧 医生：是怎么样的痛法 患者：就是那种一跳一跳的疼痛 医生：头痛一般在什么时候发作为主 患者：每当我焦虑或者休息不好的时候就容易发作 医生：你头痛起来会晕吗 患者：会啊，就是感觉整个人昏昏沉沉的那种 医生：没有那种整个屋子都在转的感觉吧 患者：没有 医生：痛起来有没有呕吐 患者：没有，但会有想吐的感觉 医生：你扭扭脖子，现在会感觉头晕吗 患者：现在暂时没有，但是感觉脖子后面那块肌肉很僵硬，不太舒服 医生：平时出汗多吗？ 患者：不多，基本没有汗，而且有的时候感觉整个人有点发冷 医生：有流鼻涕、咳嗽吗？ 患者：会流鼻涕，但没咳嗽 医生：鼻涕什么颜色，清的还是浓的？ 患者：透明的，清涕 医生：平时胃口怎么样 患者：胃口还可以 医生：晚上睡觉呢 患者：头痛起来就睡不好 医生：小便正常吗？有没有尿频尿急尿痛？ 患者：没有，挺正常的 大便呢？成形吗 患者：成形的，一天一般拉一次 医生：好，还有没有其他不舒服的 患者：好像没了 医生：有没有糖尿病、高血压之类的基础病 患者：没有 医生：有没有乙肝结核之类的传染病？ 患者：没有 医生：有没有什么药物过敏？ 患者：没有 医生：看一下舌头 医生：伸手出来把一下脉 医生：你这种情况呢，考虑是中了风寒，又没有汗，邪气散不出去，一直积聚在体内，影响了太阳经，太阳经的走行就是从头部一直沿着脖子后面下去的，所以你老是反反复复头痛，脖子后面的肌肉又感觉不舒服，我先给你开三剂药，里面的麻黄记得先煎，把上面的浮沫去掉，药煲好之后趁热喝，出一下汗，但是小心不要吹风又受凉了。中药你是要自己拿回去煲呢还是代煎？ 患者：自己拿回去煲吧 医生：好，药吃完了记得回来复诊 患者：好，我明白了，谢谢医生',
            '医生：您好，您叫什么名字，今年多大年纪呢？患者：医生您好，我叫张华，今年55岁了。医生：请告诉我您的诊疗卡号。患者：我的诊疗卡号是12345678。医生：您是哪里不舒服呢？患者：医生，我最近一个月总是感觉腹部不舒服，而且我发现我的皮肤和眼睛都变黄了，食欲也下降了，体重也减轻了。医生：这种情况持续了多久了？患者：大概一个月左右。医生：您有没有其他症状，比如恶心、呕吐或者腹痛？患者：没有恶心呕吐，但是食欲不好，偶尔会有轻微的腹痛。医生：您有没有发热或者大便颜色改变？患者：没有发热，大便颜色比较浅。医生：您以前有没有患过什么疾病？患者：我有乙型肝炎，已经10年了，而且我过去经常喝酒。20多年了医生：了解了，您这种情况我们初步考虑可能是肝硬化。我需要给您做一些检查，包括肝功能测试和腹部B超。患者：好的，医生，我听您的。医生：根据检查结果，您的肝功能指标有些异常，B超也显示肝脏表面不光滑，回声增强，这与肝硬化的表现相符。我将给您开一些中药来调理，同时您需要戒酒，饮食要清淡。患者：医生，这病严重吗？我还能治好吗？医生：肝硬化是一种慢性病，需要长期管理和治疗。我们会根据您的具体情况制定治疗方案，同时您需要配合我们的治疗和建议，定期复查。患者：好的，我会按照您说的做。医生：这是您的处方，您需要按照说明煎药和服用。记得一周后回来复诊，看看病情有没有改善。患者：明白了，谢谢医生。',
        ]
        custom_settings = init_prompts()
        inference(sentences, custom_settings)
    # except Exception as e:
    #     print(f"An error occurred: {e}")